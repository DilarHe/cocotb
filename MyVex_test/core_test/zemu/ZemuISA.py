# 定义指令集
BASE_INSTRUCTIONS = {
   ## Base Integer Extension 
   "ADD"    : "0000000----------000-----0110011",
   "SUB"    : "0100000----------000-----0110011",
   "XOR"    : "0000000----------100-----0110011",
   "OR"     : "0000000----------110-----0110011",
   "AND"    : "0000000----------111-----0110011",
   "SLL"    : "0000000----------001-----0110011",
   "SRL"    : "0000000----------101-----0110011",
   "SRA"    : "0100000----------101-----0110011",
   "SLT"    : "0000000----------010-----0110011",
   "SLTU"   : "0000000----------011-----0110011",
   "ADDI"   : "-----------------000-----0010011",
   "XORI"   : "-----------------100-----0010011",
   "ORI"    : "-----------------110-----0010011",
   "ANDI"   : "-----------------111-----0010011",
   "SLLI"   : "0000000----------001-----0010011",
   "SRLI"   : "0000000----------101-----0010011",
   "SRAI"   : "0100000----------101-----0010011",
   "SLTI"   : "-----------------010-----0010011",
   "SLTIU"  : "-----------------011-----0010011",
   "LB"     : "-----------------000-----0000011",
   "LH"     : "-----------------001-----0000011",
   "LW"     : "-----------------010-----0000011",
   "LBU"    : "-----------------100-----0000011",
   "LHU"    : "-----------------101-----0000011",
   "SB"     : "-----------------000-----0100011",
   "SH"     : "-----------------001-----0100011",
   "SW"     : "-----------------010-----0100011",
   "BEQ"    : "-----------------000-----1100011",
   "BNE"    : "-----------------001-----1100011",
   "BLT"    : "-----------------100-----1100011",
   "BGE"    : "-----------------101-----1100011",
   "BLTU"   : "-----------------110-----1100011",
   "BGEU"   : "-----------------111-----1100011",
   "JAL"    : "-------------------------1101111",
   "JALR"   : "-----------------000-----1100111",
   "LUI"    : "-------------------------0110111",
   "AUIPC"  : "-------------------------0010111",
}
SYSTEM_INSTRUCTIONS = {
    "ECALL" : "00000000000000000000000001110011",
    "EBREAK": "00000000000100000000000001110011",
    "MRET"  : "00110000001000000000000001110011"
}
M_INSTRUCTIONS = {
## Multiply Extension
   "MUL"    : "0000001----------000-----0110011",
   "MULH"   : "0000001----------001-----0110011",
   "MULHSU" : "0000001----------010-----0110011",
   "MULHU"  : "0000001----------011-----0110011",
   "DIV"    : "0000001----------100-----0110011",
   "DIVU"   : "0000001----------101-----0110011",
   "REM"    : "0000001----------110-----0110011",
   "REMU"   : "0000001----------111-----0110011"
}

ZICSR_INSTRUCTIONS = {
    # CSR类指令  
    "CSRRW"  : "-----------------001-----1110011",
    "CSRRS"  : "-----------------010-----1110011",
    "CSRRC"  : "-----------------011-----1110011",
    "CSRRWI" : "-----------------101-----1110011",
    "CSRRSI" : "-----------------110-----1110011",
    "CSRRCI" : "-----------------111-----1110011"
}

F_INSTRUCTIONS = {
    # 浮点加减乘除
    "FADD.S"  : "0000000----------111-----1010011",
    "FSUB.S"  : "0000100----------111-----1010011",
    "FMUL.S"  : "0001000----------111-----1010011",
    "FDIV.S"  : "0001100----------111-----1010011",

    # 浮点平方根
    "FSQRT.S" : "010110000000-----111-----1010011",

    # 浮点符号注入指令
    "FSGNJ.S" : "0010000----------000-----1010011",
    "FSGNJN.S": "0010000----------001-----1010011",
    "FSGNJX.S": "0010000----------010-----1010011",
    
    # 最小最大（可选）
    "FMIN.S"  : "0010100----------000-----1010011",
    "FMAX.S"  : "0010100----------001-----1010011",

    # 类型转换与按位搬运
    "FCVT.W.S"  : "110000000000-----111-----1010011", # float->int
    "FCVT.WU.S" : "110000000001-----111-----1010011",
    "FCVT.S.W"  : "110100000000-----111-----1010011", # int->float
    "FCVT.S.WU" : "110100000001-----111-----1010011",

    "FMV.X.S"   : "111000000000-----000-----1010011", # float->int(位模式)
    "FMV.S.X"   : "111100000000-----000-----1010011", # int->float(位模式)

    # 比较
    "FEQ.S"  : "1010000----------010-----1010011",
    "FLT.S"  : "1010000----------001-----1010011",
    "FLE.S"  : "1010000----------000-----1010011",

    # 浮点Load/Store
    "FLW"    : "-----------------010-----0000111",
    "FSW"    : "-----------------010-----0100111",
    
    # 浮点融合乘加/乘减指令
    "FMADD.S" : "-----00----------111-----1000011", # fma
    "FMSUB.S" : "-----00----------111-----1000111", # fmsub
    "FNMSUB.S": "-----00----------111-----1001011", # fnmsub
    "FNMADD.S": "-----00----------111-----1001111", # fnmadd

    # 浮点classification
    "FCLASS.S" : "111000000000-----001-----1010011"
}

# 合并
BASE_INSTRUCTIONS.update(SYSTEM_INSTRUCTIONS)
BASE_INSTRUCTIONS.update(M_INSTRUCTIONS)
BASE_INSTRUCTIONS.update(ZICSR_INSTRUCTIONS)
BASE_INSTRUCTIONS.update(F_INSTRUCTIONS)

COMPRESS_INSTRUCTIONS = {
   "ADDI4SPN"       : "000-----------00",
   "LW"             : "010-----------00",
   "SW"             : "110-----------00",
   # NOP rs/rd == 0 , ADDI rs/rd =/= 0
   "NOP_ADDI"       : "000-----------01",
   "JAL"            : "001-----------01",
   # LI rd =/= 0  
   "LI"             : "010-----------01",
   # ADDI16SP rd == 2 , LUI rd =/= {0,2}
   "ADDI16SP_LUI"   : "011-----------01",
   "SRLI"           : "100-00--------01",
   "SRAI"           : "100-01--------01",
   "ANDI"           : "100-10--------01",
   "SUB"            : "100011---00---01",
   "XOR"            : "100011---01---01",
   "OR"             : "100011---10---01",
   "AND"            : "100011---11---01",
   "J"              : "101-----------01",
   "BEQZ"           : "110-----------01",
   "BNEZ"           : "111-----------01",
   # SLLI rs/rd =/= 0
   "SLLI"           : "000-----------10",
   # LWSP rd =/= 0
   "LWSP"           : "010-----------10",
   # JR rs2 == 0 , MV rd/rs2 =/= 0
   "JR_MV"          : "1000----------10",
   # EBREAK rs1/rd == 0 & rs2 == 0
   # JALR rs1 =/= 0 & rs2 == 0
   # ADD rs1/rd =/= 0 & rs2 =/= 0
   "EBREAK_JALR_ADD": "1001----------10",
   "SWSP"           : "110-----------10"
}

DEFAULT_CSR_VALUES = {
    0x300: 0x00001800,  # mstatus, 通常MIE=0, MPIE=1, MPP=3
    0x301: 0x40001104,  # misa, 视具体实现而定，默认RV32IM
    0x305: 0x00000000,  # mtvec
    0x340: 0x00000000,  # mscratch
    0x341: 0x00000000,  # mepc
    0x342: 0x00000000,  # mcause
    0x343: 0x00000000,  # mtval
    0x304: 0x00000000,  # mie
    0x344: 0x00000000,  # mip
    # 其他常见CSR...
}

# CSR地址和bit
MSTATUS_ADDR = 0x300
MIE_ADDR     = 0x304
MTVEC_ADDR   = 0x305
MEPC_ADDR    = 0x341
MCAUSE_ADDR  = 0x342
MTVAL_ADDR   = 0x343
MIP_ADDR     = 0x344

MIE_BIT      = 3    # mstatus.mie
MPIE_BIT     = 7    # mstatus.mpie

MTIE_BIT     = 7    # mie.mtie
MTIP_BIT     = 7    # mip.mtip